<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Démo n8n — Soumission de note de frais</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .dropzone{border:2px dashed #d1d5db;border-radius:20px;padding:24px;text-align:center;transition:background .15s,border-color .15s}
    .dropzone.dragover{background:#f9fafb;border-color:#60a5fa}
    .thumb{cursor:pointer}
    .thumb:hover{transform:scale(1.02);transition:transform .2s}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}

    /* --- Pastilles workflow --- */
    .wf-dot{position:absolute;width:14px;height:14px;border-radius:9999px;background:#e5e7eb;box-shadow:0 0 0 2px rgba(0,0,0,.08)}
    .wf-dot.active{background:#f59e0b}  /* en cours */
    .wf-dot.ok{background:#10b981}      /* terminé */
    .wf-dot.err{background:#ef4444}     /* erreur */
    
    /* --- Styles tableau CSV --- */
    #csvTable th, #csvTable td { border: 1px solid #d1d5db; padding: 12px 16px; text-align: left; word-wrap: break-word; }
    #csvTable th { background-color: #f3f4f6; font-weight: 600; }
    #csvTable tbody tr:nth-child(even) { background-color: #f9fafb; }
    #csvTable { width: 100%; table-layout: fixed; }
    #csvTable th:nth-child(1), #csvTable td:nth-child(1) { width: 180px; } /* numero_note */
    #csvTable th:nth-child(2), #csvTable td:nth-child(2) { width: 120px; } /* nom */
    #csvTable th:nth-child(3), #csvTable td:nth-child(3) { width: 140px; white-space: nowrap; } /* date_depense */
    #csvTable th:nth-child(4), #csvTable td:nth-child(4) { width: 200px; } /* nature */
    #csvTable th:nth-child(5), #csvTable td:nth-child(5) { width: 100px; } /* montant */
  </style>
</head>
<body class="bg-gray-50">
<main class="max-w-5xl mx-auto p-6 grid grid-cols-1 md:grid-cols-[280px,1fr] gap-6">
  <!-- Colonne gauche: vignettes -->
  <aside class="bg-white rounded-2xl shadow p-4">
    <h2 class="font-semibold mb-3">Exemples de notes de frais</h2>
    <p class="text-sm text-gray-600 mb-4">Veuillez cliquer ou glisser-déposer l'une des vignettes ci-dessous pour réaliser un test.</p>
    <div class="grid grid-cols-1 gap-3">
      <figure class="text-center">
        <img src="/docs/demo/Marco.png" alt="Marco" class="thumb rounded-lg border" draggable="true" data-file="/docs/demo/Marco.png">
        <figcaption class="text-xs mt-1 text-gray-600">Marco.png</figcaption>
      </figure>
      <figure class="text-center">
        <img src="/docs/demo/Sophie.png" alt="Sophie" class="thumb rounded-lg border" draggable="true" data-file="/docs/demo/Sophie.png">
        <figcaption class="text-xs mt-1 text-gray-600">Sophie.png</figcaption>
      </figure>
    </div>
  </aside>

  <!-- Colonne droite: formulaire -->
  <section class="bg-white rounded-2xl shadow p-6">
    <header class="mb-6">
      <h1 class="text-2xl font-bold">Soumission d'une note de frais</h1>
      <p class="text-sm text-gray-500">Veuillez glisser une vignette dans la zone ci-dessous, ou cliquer dessus pour la charger. Ensuite, cliquez sur « Envoyer ».</p>
    </header>

    <form id="demoForm" class="space-y-4" method="post" enctype="multipart/form-data" action="#">
      <div id="drop" class="dropzone">
        <p id="dropHint" class="text-gray-600">Déposez une vignette ici</p>
      </div>
      <button id="send" class="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold disabled:opacity-40" type="submit" disabled>Envoyer</button>
    </form>

    <!-- Visuel workflow temps réel -->
    <aside class="mt-8 p-6 bg-gray-50 rounded-xl">
      <h3 class="font-semibold mb-4">Workflow n8n (exécution en direct)</h3>
      <div class="relative overflow-auto bg-white p-4 rounded-lg border">
        <!-- Mets ici ton export PNG/SVG du workflow -->
        <img src="/docs//assets/workflow.png" alt="Workflow n8n" class="rounded-lg w-full h-auto border" style="min-height: 300px; object-fit: contain;">

        <!-- Pastilles (positionne top/left selon ta capture) -->
        <span id="node-received"  class="wf-dot" style="top:40px;  left:60px;"></span>
        <span id="node-ocr"       class="wf-dot" style="top:110px; left:300px;"></span>
        <span id="node-extract"   class="wf-dot" style="top:150px; left:450px;"></span>
        <span id="node-hash"      class="wf-dot" style="top:190px; left:590px;"></span>
        <span id="node-dedupe"    class="wf-dot" style="top:230px; left:750px;"></span>
        <span id="node-exportcsv" class="wf-dot" style="top:270px; left:910px;"></span>
        <span id="node-done"      class="wf-dot" style="top:310px; left:1070px;"></span>
      </div>
      <ul id="wfLog" class="mt-3 text-xs text-gray-600 space-y-1 mono"></ul>
    </aside>

    <!-- Section affichage CSV -->
    <section class="mt-8 p-6 bg-white rounded-xl shadow-sm">
      <h3 class="font-semibold mb-4">Données exportées</h3>
      <div id="csvTableContainer" class="overflow-x-auto w-full">
        <div id="csvLoading" class="text-center text-gray-500 py-4">Chargement des données...</div>
        <table id="csvTable" class="hidden w-full border-collapse border border-gray-300 text-sm">
          <thead id="csvHeader" class="bg-gray-100"></thead>
          <tbody id="csvBody"></tbody>
        </table>
      </div>
      <div class="mt-4 text-center space-x-3">
        <button id="downloadCsv" class="bg-blue-600 text-white py-2 px-6 rounded-xl font-semibold hover:bg-blue-700 transition-colors">
          Télécharger CSV
        </button>
        <button id="resetDemo" class="bg-red-600 text-white py-2 px-6 rounded-xl font-semibold hover:bg-red-700 transition-colors">
          Réinitialiser la démo
        </button>
      </div>
    </section>

    <div id="resp" class="hidden mt-6">
      <div id="badge" class="inline-block text-xs px-2 py-1 rounded bg-gray-100"></div>
      <p id="msg" class="text-sm text-gray-700 mt-2"></p>
      <div class="mt-3 flex items-center gap-3">
        <button id="toggleJson" class="text-sm underline">Afficher la réponse JSON</button>
      </div>
      <pre id="json" class="hidden mt-3 bg-gray-50 p-3 rounded text-xs mono"></pre>
    </div>

    <div id="err" class="hidden mt-6 text-red-600 text-sm"></div>
  </section>
</main>

<!-- Popup modal pour les doublons -->
<div id="duplicateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-xl max-w-md w-full mx-4 p-6 transform transition-all">
    <div class="text-center">
      <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-yellow-100 mb-4">
        <svg class="h-8 w-8 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
        </svg>
      </div>
      <h3 class="text-lg font-semibold text-gray-900 mb-6">Note de frais déjà traitée</h3>
      <button id="closeDuplicateModal" class="w-full bg-blue-600 text-white py-2 px-4 rounded-xl font-semibold hover:bg-blue-700 transition-colors">
        OK
      </button>
    </div>
  </div>
</div>

<!-- Popup modal pour les succès -->
<div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-xl max-w-md w-full mx-4 p-6 transform transition-all">
    <div class="text-center">
      <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
        <svg class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      </div>
      <h3 class="text-lg font-semibold text-gray-900 mb-6">Note de frais traitée</h3>
      <button id="closeSuccessModal" class="w-full bg-green-600 text-white py-2 px-4 rounded-xl font-semibold hover:bg-green-700 transition-colors">
        OK
      </button>
    </div>
  </div>
</div>

<script>
/** ===== À CONFIGURER =====
 * Remplace par l'URL publique de ton Webhook n8n (POST multipart/form-data).
 */
//const WEBHOOK_URL = "https://n8n.marcolopes.fr/webhook-test/379815cd-a225-4dc1-b09b-9b8be0bb6107";
const WEBHOOK_URL = "https://n8n.marcolopes.fr/webhook/379815cd-a225-4dc1-b09b-9b8be0bb6107";

/** ====== Visuel workflow : config polling ====== */
const PROGRESS_BASE_URL = "/docs/progress"; // n8n écrit /docs/progress/<executionId>.json

// Pastilles: mapping étape -> id
const WF_MAP = {
  received: 'node-received',
  ocr: 'node-ocr',
  extract: 'node-extract',
  hash: 'node-hash',
  dedupe_check: 'node-dedupe',
  export_csv: 'node-exportcsv',
  done: 'node-done',
  error: 'node-done'
};
function markNode(step, status='ok'){
  const id = WF_MAP[step]; if (!id) return;
  const dot = document.getElementById(id);
  dot.classList.remove('active','ok','err');
  dot.classList.add(status==='ok' ? 'ok' : status==='active' ? 'active' : 'err');
}
function resetWorkflowDots(){
  document.querySelectorAll('.wf-dot').forEach(d=>d.className='wf-dot');
}
let pollTimer = null;
function startProgressPolling(executionId){
  clearInterval(pollTimer);
  resetWorkflowDots();
  const seen = new Set();

  pollTimer = setInterval(async ()=>{
    try{
      const res = await fetch(`${PROGRESS_BASE_URL}/${executionId}.json?ts=${Date.now()}`);
      if (!res.ok) return; // pas encore créé / pas d’étape
      const data = await res.json();

      const ul = document.getElementById('wfLog');
      ul.innerHTML = '';
      (data.steps||[]).forEach(s=>{
        if (!seen.has(s.name)){
          markNode(s.name,'active');
          setTimeout(()=>markNode(s.name, s.ok!==false?'ok':'err'), 200);
          seen.add(s.name);
        }
        const li = document.createElement('li');
        li.textContent = `${s.at} — ${s.name}${s.ok===false?' (erreur)':''}`;
        ul.appendChild(li);
      });

      if ((data.steps||[]).some(s=>s.name==='done') || (data.steps||[]).some(s=>s.name==='error')){
        clearInterval(pollTimer);
      }
    }catch(_){}
  }, 900);
}

let selectedFile = null;

// Active/désactive le bouton Envoyer et affiche le nom du fichier choisi
function enableSend(file){
  selectedFile = file;
  const sendBtn = document.getElementById('send');
  if (sendBtn) {
    sendBtn.disabled = !file;
  }
  const hint = document.getElementById('dropHint');
  if (hint) {
    hint.textContent = file ? `Fichier sélectionné : ${file.name}` : "Déposez une vignette ici";
  }
}

// Réinitialise l'interface après envoi
function resetInterface(){
  selectedFile = null;
  const sendBtn = document.getElementById('send');
  const hint = document.getElementById('dropHint');
  const resp = document.getElementById('resp');
  const err = document.getElementById('err');
  if (sendBtn) { sendBtn.disabled = true; sendBtn.textContent = 'Envoyer'; }
  if (hint) { hint.textContent = "Déposez une vignette ici"; }
  if (resp) { resp.classList.add('hidden'); }
  if (err) { err.classList.add('hidden'); }
}

// Charge une image distante et la convertit en File pour FormData
async function loadBlobIntoFile(url){
  try{
    const res = await fetch(url);
    if(!res.ok){ return showError("Impossible de charger " + url); }
    const blob = await res.blob();
    const file = new File([blob], url.split('/').pop(), {type: blob.type || 'image/png'});
    enableSend(file);
  }catch(e){
    showError("Erreur lors du chargement de la vignette.");
  }
}

// Sources (PNG) : drag & drop + clic
document.addEventListener('DOMContentLoaded', function() {
  const thumbs = document.querySelectorAll('.thumb');
  thumbs.forEach((img) => {
    img.addEventListener('dragstart', e=>{
      e.dataTransfer.setData('text/plain', img.dataset.file);
    });
    img.addEventListener('click', async ()=>{ await loadBlobIntoFile(img.dataset.file); });
  });
});

// Dropzone
document.addEventListener('DOMContentLoaded', function() {
  const drop = document.getElementById('drop');
  if (drop) {
    drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('dragover'); });
    drop.addEventListener('dragleave', ()=> drop.classList.remove('dragover'));
    drop.addEventListener('drop', async e=>{
      e.preventDefault(); drop.classList.remove('dragover');
      const url = e.dataTransfer.getData('text/plain');
      if(url) await loadBlobIntoFile(url);
    });
  }
});

// Affichage erreurs / réponses
function showError(msg){
  const err = document.getElementById('err');
  const resp = document.getElementById('resp');
  if (err) { err.textContent = msg; err.classList.remove('hidden'); }
  if (resp) { resp.classList.add('hidden'); }
  setTimeout(resetInterface, 3000);
}
function showResponse(data){
  const st = (data && data.status) || 'ok';
  if (st === 'duplicate') { showDuplicateModal(); return; }
  const resp = document.getElementById('resp');
  const badge = document.getElementById('badge');
  const msg = document.getElementById('msg');
  const json = document.getElementById('json');

  if (st === 'error') { badge.textContent = 'Erreur'; badge.className="inline-block text-xs px-2 py-1 rounded bg-red-100"; }
  else { badge.textContent = 'Nouveau document'; badge.className="inline-block text-xs px-2 py-1 rounded bg-green-100"; }

  msg.textContent = (data && data.message) ? data.message : "Traitement effectué.";
  document.getElementById('toggleJson').onclick = ()=>{
    json.classList.toggle('hidden');
    json.textContent = JSON.stringify(data, null, 2);
  };
  resp.classList.remove('hidden');
  document.getElementById('err').classList.add('hidden');
}

// Modaux
function showDuplicateModal(){
  const modal = document.getElementById('duplicateModal');
  if (modal) modal.classList.remove('hidden');
}
function closeDuplicateModal(){
  const modal = document.getElementById('duplicateModal');
  if (modal) modal.classList.add('hidden');
  setTimeout(resetInterface, 500);
  const sendBtn = document.getElementById('send');
  if (sendBtn) { sendBtn.textContent = 'Envoyer'; sendBtn.disabled = true; }
}
function showSuccessModal(){
  const modal = document.getElementById('successModal');
  if (modal) modal.classList.remove('hidden');
}
function closeSuccessModal(){
  const modal = document.getElementById('successModal');
  if (modal) modal.classList.add('hidden');
  setTimeout(resetInterface, 500);
  const sendBtn = document.getElementById('send');
  if (sendBtn) { sendBtn.textContent = 'Envoyer'; sendBtn.disabled = true; }
}

// Envoi au Webhook n8n
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('demoForm');
  const sendBtn = document.getElementById('send');
  const closeModalBtn = document.getElementById('closeDuplicateModal');
  const closeSuccessModalBtn = document.getElementById('closeSuccessModal');

  if (closeModalBtn) closeModalBtn.addEventListener('click', closeDuplicateModal);
  if (closeSuccessModalBtn) closeSuccessModalBtn.addEventListener('click', closeSuccessModal);

  const duplicateModal = document.getElementById('duplicateModal');
  if (duplicateModal) duplicateModal.addEventListener('click', (e)=>{ if (e.target === duplicateModal) closeDuplicateModal(); });
  const successModal = document.getElementById('successModal');
  if (successModal) successModal.addEventListener('click', (e)=>{ if (e.target === successModal) closeSuccessModal(); });

  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    if(!selectedFile){ return showError("Veuillez d'abord sélectionner une vignette."); }

    const originalText = sendBtn.textContent;
    sendBtn.textContent = 'Envoi en cours...';
    sendBtn.disabled = true;

    const fd = new FormData();
    fd.append('file', selectedFile);
    fd.append('origin', 'webhook');
    fd.append('demo_mode', '1');

    try{
      const res = await fetch(WEBHOOK_URL, { method: 'POST', body: fd, mode: 'cors' });
      const responseText = await res.text();
      let data;
      try { data = JSON.parse(responseText); }
      catch { data = { status:'ok', message:'Fichier transmis.' }; }

      // Si ACK avec executionId -> démarrer l’animation temps réel
      if (data && data.executionId && data.status === 'accepted'){
        markNode('received','active');
        setTimeout(()=>markNode('received','ok'),200);
        startProgressPolling(data.executionId);
        showResponse({ status:'ok', message:'Fichier transmis. Exécution démarrée.' });
        return;
      }

      // Gestion HTTP 409 (doublon) si côté serveur
      if (res.status === 409 || data.status === 'duplicate') {
        showDuplicateModal();
        return;
      }

      // Succès “final” direct
      if (res.ok && (data.status === 'ok' || data.status === 'success' || !data.error)) {
        showSuccessModal();
        return;
      }

      // Affichage générique
      showResponse(data);
      setTimeout(resetInterface, 3000);

    }catch(err){
      // 409 dans le catch → doublon probable
      if (err?.message?.includes('409')) { showDuplicateModal(); return; }
      showError("Échec d'envoi au Webhook : " + (err?.message || "erreur inconnue"));
    } finally {
      sendBtn.textContent = originalText;
      sendBtn.disabled = false;
    }
  });

  sendBtn.addEventListener('click', (e)=>{ if (sendBtn.disabled) e.preventDefault(); });

  // Chargement automatique du CSV
  loadCsvData();
});

// Fonction pour charger et afficher le CSV
async function loadCsvData() {
  const table = document.getElementById('csvTable');
  const header = document.getElementById('csvHeader');
  const body = document.getElementById('csvBody');
  const loading = document.getElementById('csvLoading');
  
  // Réinitialiser le tableau
  header.innerHTML = '';
  body.innerHTML = '';
  table.classList.add('hidden');
  loading.classList.remove('hidden');
  
  try {
    const response = await fetch('docs/ndf.csv');
    if (!response.ok) {
      loading.textContent = 'Aucun fichier CSV disponible';
      return;
    }
    
    const csvText = await response.text();
    const lines = csvText.trim().split('\n');
    
    if (lines.length === 0 || (lines.length === 1 && lines[0].trim() === '')) {
      loading.textContent = 'Fichier CSV vide';
      return;
    }
    
    // Parser la première ligne comme entêtes
    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
    
    // Créer les entêtes
    const headerRow = document.createElement('tr');
    headers.forEach(headerText => {
      const th = document.createElement('th');
      th.textContent = headerText;
      headerRow.appendChild(th);
    });
    header.appendChild(headerRow);
    
    // Créer les lignes de données
    for (let i = 1; i < lines.length; i++) {
      const line = lines[i].trim();
      if (line === '') continue; // Ignorer les lignes vides
      
      const cells = line.split(',').map(c => c.trim().replace(/"/g, ''));
      const row = document.createElement('tr');
      
      cells.forEach(cellText => {
        const td = document.createElement('td');
        td.textContent = cellText;
        row.appendChild(td);
      });
      body.appendChild(row);
    }
    
    // Afficher le tableau et masquer le loading
    loading.classList.add('hidden');
    table.classList.remove('hidden');
    
  } catch (error) {
    loading.textContent = 'Aucun fichier CSV disponible';
  }
}

// Fonction pour télécharger le CSV
document.addEventListener('DOMContentLoaded', function() {
  const downloadBtn = document.getElementById('downloadCsv');
  if (downloadBtn) {
    downloadBtn.addEventListener('click', async function() {
      try {
        const response = await fetch('docs/ndf.csv');
        if (!response.ok) {
          alert('Fichier CSV non disponible');
          return;
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'ndf.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      } catch (error) {
        alert('Erreur lors du téléchargement');
      }
    });
  }

  // Fonction pour réinitialiser la démo
  const resetBtn = document.getElementById('resetDemo');
  if (resetBtn) {
    resetBtn.addEventListener('click', async function() {
      if (!confirm('Êtes-vous sûr de vouloir réinitialiser la démo ? Cela supprimera toutes les données.')) {
        return;
      }
      
      const originalText = resetBtn.textContent;
      resetBtn.textContent = 'Réinitialisation...';
      resetBtn.disabled = true;
      
      try {
        const response = await fetch('http://localhost:3001/reset-demo', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          alert('Démo réinitialisée avec succès');
          // Recharger les données CSV
          document.getElementById('csvTable').classList.add('hidden');
          document.getElementById('csvLoading').classList.remove('hidden');
          document.getElementById('csvLoading').textContent = 'Chargement des données...';
          document.getElementById('csvHeader').innerHTML = '';
          document.getElementById('csvBody').innerHTML = '';
          setTimeout(() => loadCsvData(), 1000);
        } else {
          alert('Erreur lors de la réinitialisation');
        }
      } catch (error) {
        alert('Erreur lors de la réinitialisation: ' + error.message);
      } finally {
        resetBtn.textContent = originalText;
        resetBtn.disabled = false;
      }
    });
  }
});
</script>
</body>
</html>
